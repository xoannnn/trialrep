<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pronunciation Practice</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 40px;
    max-width: 900px;
  }

  .section {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #ddd;
  }

  .content { flex: 1; }

  button {
    padding: 8px 14px;
    font-size: 15px;
    margin-right: 6px;
    cursor: pointer;
  }

  input {
    padding: 8px;
    font-size: 16px;
  }

  .word {
    padding: 3px 6px;
    margin: 2px;
    display: inline-block;
    border-radius: 4px;
  }

  .correct { background: #c8f7c5; }
  .wrong   { background: #f7c5c5; }

  .result { margin-top: 12px; }

  #scoreBox {
    position: fixed;
    top: 15px;
    right: 15px;
    background: #222;
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 15px;
    z-index: 9999;
  }
</style>
</head>

<body>

<h2>Pronunciation Practice</h2>

<!-- Name submit -->
<div class="section">
  <div class="content">
    <p><strong>What is your name?</strong></p>
    <input id="studentNameInput" type="text" placeholder="Type your name">
    <button onclick="submitName()">Submit name</button>
    <p id="nameStatus"></p>
  </div>
</div>

<!-- Floating score -->
<div id="scoreBox">Student — Score: 0 / 16</div>

<!-- Sentences -->
<div id="sentences"></div>

<script>
/* ---------------- DATA ---------------- */

const targets = {
  1: "Whose tablet is this?",
  2: "It's his.",
  3: "Whose pen is that?",
  4: "It's hers.",
  5: "Whose book is this?",
  6: "It's theirs.",
  7: "Whose school is this?",
  8: "It's ours."
};

/* Forgiving pronunciation map */
const pronunciationMap = {
  whose: ["whos", "who's", "whois"],
  whos: ["whose", "who's"],
  its: ["it's", "it’s"],
  "it's": ["its"],

// hers family (Japanese-friendly)
  hers: ["hearse", "hears", "hear", "hearsay"],
  hearse: ["hers", "hears"],
  hears: ["hers", "hearse"],
};

let studentName = "";
let sentenceScores = {};

const totalWords = Object.values(targets)
  .map(t => normalise(t).split(" ").length)
  .reduce((a,b) => a + b, 0);

/* ---------------- BUILD UI ---------------- */

function buildUI() {
  const container = document.getElementById("sentences");
  for (let id in targets) {
    container.innerHTML += `
      <div class="section">
        <div class="content">
          <p><strong>${id}. ${targets[id]}</strong></p>
          <button onclick="playSentence(${id})">▶️ Play</button>
          <button onclick="startRecording(${id})">🎤 Speak</button>
          <div class="result" id="result${id}"></div>
        </div>
      </div>
    `;
  }
}
buildUI();

/* ---------------- NAME ---------------- */

function submitName() {
  const input = document.getElementById("studentNameInput");
  const name = input.value.trim();

  if (!name) {
    alert("Please enter your name.");
    return;
  }

  studentName = name;
  input.disabled = true;

  document.getElementById("nameStatus").innerText =
    `Hello ${studentName}! Let's start`;

  updateGlobalScore();
}

/* ---------------- UTIL ---------------- */

function normalise(text) {
  return text.toLowerCase().replace(/[^\w\s]/g, "").trim();
}

function wordsMatch(target, spoken) {
  if (target === spoken) return true;
  if (pronunciationMap[target]?.includes(spoken)) return true;
  if (pronunciationMap[spoken]?.includes(target)) return true;
  return false;
}

function updateGlobalScore() {
  let sum = 0;
  for (let k in sentenceScores) sum += sentenceScores[k];

  document.getElementById("scoreBox").innerText =
    `${studentName || "Student"} — Score: ${sum} / ${totalWords}`;
}

/* ---------------- TTS ---------------- */

function playSentence(id) {
  const u = new SpeechSynthesisUtterance(targets[id]);
  u.lang = "en-US";
  u.rate = 0.9;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ---------------- RECORDING ---------------- */

function startRecording(id) {
  if (!studentName) {
    alert("Please submit your name first.");
    return;
  }

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Speech Recognition not supported.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  recognition.interimResults = false;

  const targetWords = normalise(targets[id]).split(" ");
  const resultDiv = document.getElementById("result" + id);

  resultDiv.innerHTML = "Listening...";
  recognition.start();

  recognition.onresult = (e) => {
    const spokenWords =
      normalise(e.results[0][0].transcript).split(" ");

    let correct = 0;
    let output = "<p><strong>Analysis:</strong></p>";

    targetWords.forEach((tw, i) => {
      if (wordsMatch(tw, spokenWords[i])) {
        correct++;
        output += `<span class="word correct">${tw}</span>`;
      } else {
        output += `<span class="word wrong">${tw}</span>`;
      }
    });

    // overwrite score (no stacking)
    sentenceScores[id] = correct;
    updateGlobalScore();

    resultDiv.innerHTML = `
      <p><strong>You said:</strong> "${spokenWords.join(" ")}"</p>
      ${output}
      <p><strong>Sentence score:</strong> ${correct} / ${targetWords.length}</p>
    `;
  };

  recognition.onerror = () => {
    resultDiv.innerHTML = "Error recognising speech.";
  };
}
</script>

</body>
</html>
