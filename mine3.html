<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pronunciation Practice</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      max-width: 900px;
    }

    /* FLOATING SCORE */
    .score-box {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #222;
      color: #fff;
      padding: 12px 18px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      z-index: 9999;
      text-align: center;
    }

    .section {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }

    .content {
      flex: 1;
    }

    input[type="text"] {
      padding: 8px;
      font-size: 16px;
      width: 250px;
      margin-right: 8px;
    }

    button {
      padding: 8px 14px;
      font-size: 15px;
      cursor: pointer;
      margin-top: 6px;
      margin-right: 6px;
    }

    .word {
      padding: 3px 6px;
      margin: 2px;
      display: inline-block;
      border-radius: 4px;
    }

    .correct { background: #c8f7c5; }
    .wrong   { background: #f7c5c5; }
    .extra   { background: #f7e3c5; }

    .result {
      margin-top: 15px;
      font-size: 16px;
    }

    .score-text {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<!-- FLOATING SCORE -->
<div class="score-box" id="globalScore">
  Score: 0 / 0<br>
  Correct words: 0
</div>

<h2>Pronunciation Practice</h2>

<!-- NAME INPUT -->
<div class="section">
  <div class="content">
    <p><strong>Before we start: What is your name?</strong></p>
    <input type="text" id="nameInput" placeholder="Write your name">
    <button onclick="saveName()">Start</button>
    <div class="result" id="nameResult"></div>
  </div>
</div>

<!-- SENTENCES -->
<div class="section"><div class="content">
<p><strong>1. Whose tablet is this?</strong></p>
<button onclick="playSentence(1)">▶️ Play</button>
<button onclick="startRecording(1)">🎤 Start Speaking</button>
<div class="result" id="result1"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>2. It's his.</strong></p>
<button onclick="playSentence(2)">▶️ Play</button>
<button onclick="startRecording(2)">🎤 Start Speaking</button>
<div class="result" id="result2"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>3. Whose bag is that?</strong></p>
<button onclick="playSentence(3)">▶️ Play</button>
<button onclick="startRecording(3)">🎤 Start Speaking</button>
<div class="result" id="result3"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>4. It's hers.</strong></p>
<button onclick="playSentence(4)">▶️ Play</button>
<button onclick="startRecording(4)">🎤 Start Speaking</button>
<div class="result" id="result4"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>5. Whose book is this?</strong></p>
<button onclick="playSentence(5)">▶️ Play</button>
<button onclick="startRecording(5)">🎤 Start Speaking</button>
<div class="result" id="result5"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>6. It's theirs.</strong></p>
<button onclick="playSentence(6)">▶️ Play</button>
<button onclick="startRecording(6)">🎤 Start Speaking</button>
<div class="result" id="result6"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>7. Whose school is this?</strong></p>
<button onclick="playSentence(7)">▶️ Play</button>
<button onclick="startRecording(7)">🎤 Start Speaking</button>
<div class="result" id="result7"></div>
</div></div>

<div class="section"><div class="content">
<p><strong>8. It's ours.</strong></p>
<button onclick="playSentence(8)">▶️ Play</button>
<button onclick="startRecording(8)">🎤 Start Speaking</button>
<div class="result" id="result8"></div>
</div></div>

<script>
const targets = {
  1: "Whose tablet is this?",
  2: "It's his.",
  3: "Whose bag is that?",
  4: "It's hers.",
  5: "Whose book is this?",
  6: "It's theirs.",
  7: "Whose school is this?",
  8: "It's ours."
};

// BEST attempt per sentence
let bestCorrectPerSentence = {};
for (let i=1;i<=8;i++) bestCorrectPerSentence[i] = 0;

// CUMULATIVE total correct words (all attempts)
let cumulativeCorrect = 0;

// Total words in all sentences
let totalWords = Object.values(targets).map(t => normalise(t).split(" ").length).reduce((a,b)=>a+b,0);

function updateGlobalScore() {
  let score = Object.values(bestCorrectPerSentence).reduce((a,b)=>a+b,0);
  document.getElementById("globalScore").innerHTML =
    `Score: ${score} / ${totalWords}<br>Correct words: ${cumulativeCorrect}`;
}

function saveName() {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) return;
  document.getElementById("nameResult").innerHTML =
    `<strong>Hello, ${name}! Let’s begin.</strong>`;
}

function normalise(text) {
  return text.toLowerCase().replace(/[^\w\s]/g,"").trim();
}

function playSentence(id) {
  const u = new SpeechSynthesisUtterance(targets[id]);
  u.lang = "en-US";
  u.rate = 0.9;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function startRecording(id) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { alert("Speech Recognition not supported."); return; }

  const targetWords = normalise(targets[id]).split(" ");
  const resultDiv = document.getElementById("result"+id);

  const recognition = new SpeechRecognition();
  recognition.lang = "en-US";
  resultDiv.innerHTML = "Listening...";
  recognition.start();

  recognition.onresult = (e) => {
    const spokenWords = normalise(e.results[0][0].transcript).split(" ");
    let correct = 0;
    let output = "<p><strong>Analysis:</strong></p>";
    const maxLen = Math.max(targetWords.length, spokenWords.length);

    for (let i=0;i<maxLen;i++){
      const t = targetWords[i];
      const s = spokenWords[i];

      if (t && s){
        if (t===s){
          correct++;
          output += `<span class="word correct">${s}</span>`;
        } else {
          output += `<span class="word wrong">${s}</span>`;
        }
      } else if (!t && s) {
        output += `<span class="word extra">${s}</span>`;
      } else if (t && !s) {
        output += `<span class="word wrong">${t}</span>`;
      }
    }

    // Update BEST attempt for this sentence
    if(correct > bestCorrectPerSentence[id]) bestCorrectPerSentence[id] = correct;

    // Update CUMULATIVE correct words
    cumulativeCorrect += correct;

    updateGlobalScore();

    resultDiv.innerHTML = `
      <p><strong>You said:</strong> "${spokenWords.join(" ")}"</p>
      ${output}
      <div class="score-text">Correct words this sentence: ${correct} / ${targetWords.length}</div>
    `;
  };

  recognition.onerror = () => { resultDiv.innerHTML = "Error recognising speech."; };
}

updateGlobalScore();
</script>
</body>
</html>
